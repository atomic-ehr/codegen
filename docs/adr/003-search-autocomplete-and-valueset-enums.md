# ADR 003: Search Autocomplete and ValueSet Enum Generation

## Status
Proposed

## Context
The current REST client generator includes an Enhanced Search Parameter types file and basic validation/building helpers generated by `SearchParameterEnhancer`. It improves type safety for FHIR search parameters but lacks:

- IDE autocomplete for search parameter names and modifiers in a fluent, chained API.
- String literal unions/enums for known ValueSet-bound token parameters (e.g., Patient.gender, Observation.status) to strengthen typing and autocomplete.
- A discoverable, helpful developer experience for building complex chained search queries.

This ADR proposes a plan to evolve the generator to provide autocomplete-driven search building and to generate enums for common ValueSets when possible.

## Goals
- Provide a chainable (fluent) search builder with strong typing and IDE autocomplete.
- Generate string literal unions (enums in TS) for selected ValueSets to enhance DX and safety.
- Keep backwards compatibility with current EnhancedSearchParams types and simple object-based search.
- Make features configurable via `restClient` options.

## Non-Goals
- Full parsing of all SearchParameter resources from external packages in this iteration (can be incremental).
- Runtime validation of ValueSet membership; this ADR focuses on compile-time typing.

## Decisions
1. Add configuration flags to `restClient`:
   - `chainedSearchBuilder?: boolean` – enables generation of fluent chained search builders.
   - `searchAutocomplete?: boolean` – enables generation of string literal unions for parameter names and helper overloads to aid autocomplete.
   - `generateValueSetEnums?: boolean` – emits string literal unions for well-known ValueSets (Patient.gender, Observation.status, etc.) when the binding strength and codes are available in the loaded packages.

2. Preserve existing behavior by default (all new flags default to `false`).

3. Introduce a phased implementation plan (tracked in tasks/):
   - Phase A: Analysis and scaffolding.
   - Phase B: Minimal autocomplete and ValueSet unions for a small set of common params.
   - Phase C: Full chained builder with modifiers support and include/revinclude.

## Design Sketch
- Extend `SearchParameterEnhancer` to optionally emit:
  - A `SearchParamName<TResource>` union of known parameter names for each resource when `searchAutocomplete` is true.
  - Value set unions e.g., `type PatientGender = 'male' | 'female' | 'other' | 'unknown'` guarded by `generateValueSetEnums`.
- Add a new generator: `search-builder.ts` which, when `chainedSearchBuilder` is true, creates per-resource builders like `PatientSearchBuilder` with methods per param: `.name()`, `.birthdate()`, `.gender()` etc., returning typed operator objects: `.contains()`, `.exact()`, `.gt()`, `.lt()`, `.eq()`, etc.
- Builder compiles down to URLSearchParams using the existing `SearchParameterValidator.buildSearchParams` as much as possible.

## Risks
- ValueSet completeness varies by package. We’ll start with a curated subset and progressively expand.
- Output size growth. We’ll mitigate with opt-in flags and file-splitting where necessary.

## Alternatives Considered
- Relying only on JSDoc and overloads without types – poorer compile-time guarantees.
- Generating TS Enums instead of unions – heavier DX in JS/ESM contexts, unions are preferable.

## Migration
- No breaking changes when flags are off.
- When flags are turned on, new files are generated but existing imports remain valid.

## Acceptance Criteria
- Config includes the three new flags with defaults set to false.
- Tasks exist under `tasks/todo/` describing implementation steps and acceptance checks.
- Documentation (ROADMAP) updated to reflect the plan.

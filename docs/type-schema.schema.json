{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://fhir-clj.github.io/type-schema/type-schema.schema.json",
  "title": "Type Schema",
  "description": "Type Schema for FHIR SDK generation",
  "oneOf": [
    {
      "$ref": "#/$defs/primitive-type-schema"
    },
    {
      "$ref": "#/$defs/resource-schema"
    },
    {
      "$ref": "#/$defs/profile-schema"
    },
    {
      "$ref": "#/$defs/valueset-schema"
    },
    {
      "$ref": "#/$defs/binding-schema"
    }
  ],
  "$defs": {
    "identifier": {
      "type": "object",
      "properties": {
        "kind": {
          "type": "string",
          "enum": [
            "primitive-type",
            "resource",
            "complex-type",
            "nested",
            "logical",
            "value-set",
            "binding",
            "profile"
          ]
        },
        "package": {
          "type": "string"
        },
        "version": {
          "type": "string"
        },
        "name": {
          "type": "string"
        },
        "url": {
          "type": "string",
          "pattern": "^(https?://|urn:)[^\\s]+$"
        }
      },
      "required": [
        "kind",
        "package",
        "version",
        "name",
        "url"
      ]
    },
    "field": {
      "oneOf": [
        {
          "$ref": "#/$defs/field.regular"
        },
        {
          "$ref": "#/$defs/field.polymorphic-declaration"
        },
        {
          "$ref": "#/$defs/field.polymorphic-instance"
        }
      ]
    },
    "field.regular": {
      "type": "object",
      "properties": {
        "type": {
          "$ref": "#/$defs/identifier"
        },
        "reference": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/identifier"
          }
        },
        "required": {
          "type": "boolean"
        },
        "excluded": {
          "type": "boolean"
        },
        "array": {
          "type": "boolean"
        },
        "binding": {
          "$ref": "#/$defs/identifier"
        },
        "enum": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "min": {
          "type": "number"
        },
        "max": {
          "type": "number"
        }
      }
    },
    "field.polymorphic-declaration": {
      "type": "object",
      "properties": {
        "choices": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "required": {
          "type": "boolean"
        },
        "excluded": {
          "type": "boolean"
        },
        "array": {
          "type": "boolean"
        },
        "min": {
          "type": "number"
        },
        "max": {
          "type": "number"
        }
      },
      "required": [
        "choices"
      ]
    },
    "field.polymorphic-instance": {
      "type": "object",
      "properties": {
        "choiceOf": {
          "type": "string"
        },
        "type": {
          "$ref": "#/$defs/identifier"
        },
        "reference": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/identifier"
          }
        },
        "required": {
          "type": "boolean"
        },
        "excluded": {
          "type": "boolean"
        },
        "array": {
          "type": "boolean"
        },
        "binding": {
          "$ref": "#/$defs/identifier"
        },
        "enum": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "min": {
          "type": "number"
        },
        "max": {
          "type": "number"
        }
      },
      "required": [
        "choiceOf"
      ]
    },
    "nested": {
      "type": "object",
      "properties": {
        "identifier": {
          "$ref": "#/$defs/identifier"
        },
        "base": {
          "$ref": "#/$defs/identifier"
        },
        "fields": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/$defs/field"
          }
        }
      },
      "required": [
        "identifier",
        "base",
        "fields"
      ]
    },
    "primitive-type-schema": {
      "type": "object",
      "properties": {
        "identifier": {
          "allOf": [
            { "$ref": "#/$defs/identifier" },
            { "properties": { "kind": { "const": "primitive-type" } } }
          ]
        },
        "description": {
          "type": "string"
        }
      },
      "required": [
        "identifier"
      ],
      "additionalProperties": false
    },
    "resource-schema": {
      "type": "object",
      "properties": {
        "identifier": {
          "allOf": [
            { "$ref": "#/$defs/identifier" },
            { "properties": { "kind": { "enum": ["resource", "complex-type", "logical", "nested"] } } }
          ]
        },
        "base": {
          "$ref": "#/$defs/identifier"
        },
        "description": {
          "type": "string"
        },
        "fields": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/$defs/field"
          }
        },
        "nested": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/nested"
          }
        }
      },
      "required": [
        "identifier"
      ],
      "additionalProperties": false
    },
    "profile-schema": {
      "type": "object",
      "properties": {
        "identifier": {
          "allOf": [
            { "$ref": "#/$defs/identifier" },
            { "properties": { "kind": { "const": "profile" } } }
          ]
        },
        "base": {
          "$ref": "#/$defs/identifier"
        },
        "description": {
          "type": "string"
        },
        "fields": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/$defs/field"
          }
        },
        "nested": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/nested"
          }
        },
        "metadata": {
          "type": "object"
        },
        "constraints": {
          "type": "object"
        },
        "extensions": {
          "type": "array"
        },
        "validation": {
          "type": "array"
        }
      },
      "required": [
        "identifier",
        "base"
      ],
      "additionalProperties": false
    },
    "valueset-schema": {
      "type": "object",
      "properties": {
        "identifier": {
          "allOf": [
            { "$ref": "#/$defs/identifier" },
            { "properties": { "kind": { "const": "value-set" } } }
          ]
        },
        "description": {
          "type": "string"
        },
        "concept": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "code": {
                "type": "string"
              },
              "display": {
                "type": "string"
              },
              "system": {
                "type": "string"
              }
            },
            "required": [
              "code"
            ]
          }
        },
        "compose": {
          "type": "object",
          "properties": {
            "include": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "system": {
                    "type": "string"
                  },
                  "concept": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "code": {
                          "type": "string"
                        },
                        "display": {
                          "type": "string"
                        }
                      },
                      "required": [
                        "code"
                      ]
                    }
                  },
                  "filter": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "property": {
                          "type": "string"
                        },
                        "op": {
                          "type": "string"
                        },
                        "value": {
                          "type": "string"
                        }
                      },
                      "required": [
                        "property",
                        "op",
                        "value"
                      ]
                    }
                  },
                  "valueSet": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  }
                }
              }
            },
            "exclude": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "system": {
                    "type": "string"
                  },
                  "concept": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "code": {
                          "type": "string"
                        },
                        "display": {
                          "type": "string"
                        }
                      },
                      "required": [
                        "code"
                      ]
                    }
                  },
                  "filter": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "property": {
                          "type": "string"
                        },
                        "op": {
                          "type": "string"
                        },
                        "value": {
                          "type": "string"
                        }
                      },
                      "required": [
                        "property",
                        "op",
                        "value"
                      ]
                    }
                  },
                  "valueSet": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        }
      },
      "required": [
        "identifier"
      ],
      "additionalProperties": false
    },
    "binding-schema": {
      "type": "object",
      "properties": {
        "identifier": {
          "allOf": [
            { "$ref": "#/$defs/identifier" },
            { "properties": { "kind": { "const": "binding" } } }
          ]
        },
        "type": {
          "$ref": "#/$defs/identifier"
        },
        "valueset": {
          "$ref": "#/$defs/identifier"
        },
        "strength": {
          "type": "string"
        },
        "enum": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "identifier",
        "valueset",
        "strength"
      ],
      "additionalProperties": false
    }
  }
}